<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>英语语调录音练习</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: #f7f7f7;
      color: #222;
      margin: 0;
      padding: 24px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 16px;
    }
    h2 {
      font-size: 20px;
      margin-top: 32px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 6px;
    }
    h3 {
      font-size: 16px;
      margin-top: 20px;
      color: #444;
    }
    .sentence {
      background: #fff;
      border-radius: 8px;
      padding: 16px;
      margin: 12px 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    .text {
      font-size: 16px;
      line-height: 1.4;
    }
    button {
      border: none;
      border-radius: 20px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      background: #2563eb;
      color: #fff;
    }
    button.recording {
      background: #dc2626;
    }
    audio {
      margin-left: 12px;
    }
    .note {
      font-size: 13px;
      color: #666;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <!-- 知情同意弹窗 -->
  <div id="consentModal" style="position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:9999;">
    <div style="background:#fff;max-width:640px;padding:24px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.2);">
      <h2 style="margin-top:0;">被试知情同意说明</h2>
      <p style="font-size:14px;line-height:1.6;color:#333;">
        您将参与一项关于<strong>重庆方言背景学习者英语语音（超音段特征）</strong>的学术研究。本实验仅采集您的英语朗读语音数据，用于分析语调、重音与节奏特征。
      </p>
      <p style="font-size:14px;line-height:1.6;color:#333;">
        <strong>数据用途：</strong>录音数据将仅用于学术研究与论文发表，所有数据在分析与发表过程中均以匿名形式呈现，不涉及任何个人身份识别。
      </p>
      <p style="font-size:14px;line-height:1.6;color:#333;">
        <strong>参与自愿：</strong>您的参与完全自愿，可在任何阶段退出实验，退出不会带来任何不利后果。
      </p>
      <p style="font-size:14px;line-height:1.6;color:#333;">
        若您已年满 18 周岁，并理解以上说明，请点击“我同意”继续实验。
      </p>
      <div style="display:flex;justify-content:flex-end;gap:12px;margin-top:20px;">
        <button onclick="declineConsent()" style="background:#9ca3af;">不同意</button>
        <button onclick="acceptConsent()">我同意</button>
      </div>
    </div>
  </div>
  <div class="container">
    <h1>英语语调录音实验（重庆方言 × 英语超音段迁移）</h1>

    <div class="sentence" style="flex-direction:column;align-items:flex-start;">
      <div class="text"><strong>被试信息</strong></div>
      <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px;">
        <label>姓名：<input id="participantName" type="text" style="padding:4px 8px;"></label>
        <label>被试编号：<input id="participantID" type="text" style="padding:4px 8px;"></label>
        <label>测试时间：<input id="testTime" type="datetime-local" style="padding:4px 8px;"></label>
      </div>
      <div class="note">请在开始录音前填写完整，用于实验标注与后续语音分析。</div>
    </div>

    <h2>① 陈述句（Declaratives）</h2>

    <h3>宽焦点（Broad focus）</h3>
    <div class="sentence" data-code="D-BF-01"><div class="text"><small>[D-BF-01]</small> She bought a new coat yesterday.</div><button onclick="toggleRecord(this)">录音</button></div>
    <div class="sentence" data-code="D-BF-02"><div class="text"><small>[D-BF-02]</small> The children are playing in the garden.</div><button onclick="toggleRecord(this)">录音</button></div>
    <div class="sentence" data-code="D-BF-03"><div class="text"><small>[D-BF-03]</small> He finished the report before lunch.</div><button onclick="toggleRecord(this)">录音</button></div>
    <div class="note">功能：基线语调、句末降调、整体 F0 轮廓</div>

    <h3>宾语焦点（Object focus）</h3>
    <div class="sentence" data-code="D-OF-01"><div class="text"><small>[D-OF-01]</small> She bought a <strong>NEW COAT</strong> yesterday.</div><button onclick="toggleRecord(this)">录音</button></div>
    <div class="sentence" data-code="D-OF-02"><div class="text"><small>[D-OF-02]</small> He finished the <strong>REPORT</strong> before lunch.</div><button onclick="toggleRecord(this)">录音</button></div>
    <div class="sentence" data-code="D-OF-03"><div class="text"><small>[D-OF-03]</small> The children are playing in the <strong>GARDEN</strong>.</div><button onclick="toggleRecord(this)">录音</button></div>
    <div class="note">功能：核重音位置 + 焦点后去重音</div>

    <h2>② 是 / 否疑问句（Yes–No Questions）</h2>
    <div class="sentence" data-code="YN-01"><div class="text"><small>[YN-01]</small> Did she buy a new coat yesterday?</div><button onclick="toggleRecord(this)">录音</button></div>
    <div class="sentence" data-code="YN-02"><div class="text"><small>[YN-02]</small> Are the children playing in the garden?</div><button onclick="toggleRecord(this)">录音</button></div>
    <div class="sentence" data-code="YN-03"><div class="text"><small>[YN-03]</small> Did he finish the report before lunch?</div><button onclick="toggleRecord(this)">录音</button></div>
    <div class="sentence" data-code="YN-04"><div class="text"><small>[YN-04]</small> Are they moving to the city this year?</div><button onclick="toggleRecord(this)">录音</button></div>
    <div class="sentence" data-code="YN-05"><div class="text"><small>[YN-05]</small> Did you meet her after the meeting?</div><button onclick="toggleRecord(this)">录音</button></div>
    <div class="sentence" data-code="YN-06"><div class="text"><small>[YN-06]</small> Is he working late tonight?</div><button onclick="toggleRecord(this)">录音</button></div>
    <div class="note">功能：RP vs GA 的关键区分（句尾升调幅度与形态）</div>

    <h2>③ WH‑疑问句</h2>
    <div class="sentence" data-code="WH-01"><div class="text"><small>[WH-01]</small> Who bought a new coat yesterday?</div><button onclick="toggleRecord(this)">录音</button></div>
    <div class="sentence" data-code="WH-02"><div class="text"><small>[WH-02]</small> Where are the children playing now?</div><button onclick="toggleRecord(this)">录音</button></div>
    <div class="sentence" data-code="WH-03"><div class="text"><small>[WH-03]</small> When did he finish the report?</div><button onclick="toggleRecord(this)">录音</button></div>
    <div class="sentence" data-code="WH-04"><div class="text"><small>[WH-04]</small> Why did they move to the city?</div><button onclick="toggleRecord(this)">录音</button></div>
    <div class="note">功能：检验过度升调与句末调型迁移</div>

    <div class="sentence" style="justify-content:flex-start;gap:16px;">
      <button onclick="exportAll()">一键导出全部录音</button>
      <button onclick="submitToServer()">提交实验</button>
      <span class="note">导出用于本地备份；提交用于上传至研究服务器</span>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
  // 伦理同意状态
  let consentGiven = false;
  let consentTimestamp = null;


  async function submitToServer() {
    if (!consentGiven) {
      alert('请先阅读并同意知情同意说明');
      return;
    }

    if (recordings.length === 0) {
      alert('尚未录制任何音频');
      return;
    }

    const pid = document.getElementById('participantID').value;
    const name = document.getElementById('participantName').value;
    const time = document.getElementById('testTime').value;

    if (!pid || !name || !time) {
      alert('请填写完整被试信息');
      return;
    }

    const zip = new JSZip();
    recordings.forEach(r => zip.file(r.filename, r.blob));
    const zipBlob = await zip.generateAsync({ type: 'blob' });

    const formData = new FormData();
    formData.append('participant_id', pid);
    formData.append('participant_name', name);
    formData.append('test_time', time);
    formData.append('consent', 'true');
    formData.append('consent_timestamp', consentTimestamp);
    formData.append('zipfile', zipBlob, `${pid}.zip`);

    try {
      const response = await fetch('/submit', {
        method: 'POST',
        body: formData
      });

      if (response.ok) {
        alert('实验数据已成功提交，感谢参与！');
      } else {
        alert('提交失败，请联系研究者');
      }
    } catch (e) {
      alert('无法连接服务器，请检查网络或稍后重试');
    }
  }
</script>
<script>
  let mediaRecorder;
  let chunks = [];
  const recordings = [];

  async function toggleRecord(button) {
    const sentenceDiv = button.closest('.sentence');
    const code = sentenceDiv.dataset.code;
    const pid = document.getElementById('participantID').value || 'UNKNOWN';

    if (mediaRecorder && mediaRecorder.state === 'recording') {
      mediaRecorder.stop();
      button.classList.remove('recording');
      button.textContent = '录音';
      return;
    }

    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    chunks = [];

    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = () => {
      const blob = new Blob(chunks, { type: 'audio/webm' });
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
      const filename = `${pid}_${code}_${timestamp}.webm`;
      recordings.push({ filename, blob });

      const audio = document.createElement('audio');
      audio.controls = true;
      audio.src = URL.createObjectURL(blob);
      sentenceDiv.appendChild(audio);
    };

    mediaRecorder.start();
    button.classList.add('recording');
    button.textContent = '停止';
  }

  function exportAll() {
    if (recordings.length === 0) {
      alert('尚未录制任何音频');
      return;
    }
    const zip = new JSZip();
    recordings.forEach(r => zip.file(r.filename, r.blob));
    zip.generateAsync({ type: 'blob' }).then(content => {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(content);
      a.download = 'recordings.zip';
      a.click();
    });
  }
  function acceptConsent() {
    consentGiven = true;
    consentTimestamp = new Date().toISOString();
    document.getElementById('consentModal').style.display = 'none';
  }

  function declineConsent() {
    alert('您未同意参与实验，页面将无法继续使用。');
  }
</script>
</body>
</html>

---

## Flask 后端（/submit + metadata.json 自动生成）

```python
from flask import Flask, request, jsonify
from datetime import datetime
import os, json, zipfile

app = Flask(__name__)

BASE_DIR = "data"
os.makedirs(BASE_DIR, exist_ok=True)

@app.route('/submit', methods=['POST'])
def submit():
    pid = request.form.get('participant_id')
    name = request.form.get('participant_name')
    test_time = request.form.get('test_time')
    consent = request.form.get('consent')
    consent_ts = request.form.get('consent_timestamp')
    zip_file = request.files.get('zipfile')

    if not all([pid, name, test_time, consent, consent_ts, zip_file]):
        return jsonify({'error': 'Missing fields'}), 400

    timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
    subject_dir = os.path.join(BASE_DIR, f"{pid}_{timestamp}")
    os.makedirs(subject_dir, exist_ok=True)

    zip_path = os.path.join(subject_dir, 'recordings.zip')
    zip_file.save(zip_path)

    with zipfile.ZipFile(zip_path, 'r') as z:
        z.extractall(os.path.join(subject_dir, 'recordings'))

    metadata = {
        'participant_id': pid,
        'participant_name': name,
        'test_time': test_time,
        'consent': consent == 'true',
        'consent_timestamp': consent_ts,
        'submission_time': datetime.now().isoformat(),
        'n_recordings': len(os.listdir(os.path.join(subject_dir, 'recordings')))
    }

    with open(os.path.join(subject_dir, 'metadata.json'), 'w', encoding='utf-8') as f:
        json.dump(metadata, f, ensure_ascii=False, indent=2)

    return jsonify({'status': 'ok'})

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)
```

